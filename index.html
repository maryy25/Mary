<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙÙƒÙ’ØªÙØ¨ÙØ©Ù Ù…ÙØ§Ø±ÙÙŠ ğŸ¦‹ğŸ€</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Great+Vibes&family=Amiri:wght@700&display=swap" rel="stylesheet">
    
    <!-- Ø§Ù„Ù…ÙƒØ§ØªØ¨ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { 
                    fontFamily: { 
                        sans: ['Tajawal', 'sans-serif'],
                        script: ['"Great Vibes"', 'cursive'],
                        deco: ['"Amiri"', 'serif'],
                    },
                    colors: {
                        primary: '#db2777',
                        secondary: '#fce7f3',
                        darkBg: '#1a1025',
                        darkCard: '#2d1b36',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Tajawal', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .category-btn.active { background-color: #db2777; color: white; border-color: #db2777; }
        .dark .category-btn.active { background-color: #be185d; border-color: #be185d; }
        iframe { background-color: white; }
    </style>
</head>

<body class="min-h-screen bg-pink-50 text-gray-800 dark:bg-darkBg dark:text-pink-100 relative selection:bg-pink-200">

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Toast Container) -->
    <div id="toast-container" class="fixed bottom-4 left-4 z-[60] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Ø²Ø± Ø§Ù„ØµØ¹ÙˆØ¯ Ù„Ù„Ø£Ø¹Ù„Ù‰ -->
    <button id="scrollTopBtn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
        class="fixed bottom-6 right-6 bg-pink-600 hover:bg-pink-700 text-white p-3 rounded-full shadow-lg translate-y-20 opacity-0 transition-all duration-300 z-40 cursor-pointer">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>

    <!-- Ø§Ù„Ø±Ø£Ø³ -->
    <header class="bg-gradient-to-r from-pink-600 to-rose-500 dark:from-pink-900 dark:to-purple-900 text-white shadow-lg sticky top-0 z-40 transition-colors duration-300">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-md border-2 border-pink-200">
                        <span class="font-script text-3xl text-pink-600 pt-1 pr-1 font-bold">My</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-3xl font-deco font-bold tracking-wide text-white drop-shadow-md">Ù…ÙÙƒÙ’ØªÙØ¨ÙØ©Ù Ù…ÙØ§Ø±ÙÙŠ</h1>
                        <span class="bg-white/20 px-2 py-1 rounded-full text-xl shadow-sm border border-white/10">ğŸ¦‹ğŸ€</span>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="toggleDarkMode()" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition shadow-sm" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                        <i data-lucide="moon" class="w-6 h-6 dark:hidden"></i>
                        <i data-lucide="sun" class="w-6 h-6 hidden dark:block text-yellow-300"></i>
                    </button>
                    <button onclick="filterFavorites()" id="favFilterBtn" class="p-2 bg-white/20 rounded-full hover:bg-white/30 transition shadow-sm" title="Ø§Ù„Ù…ÙØ¶Ù„Ø©">
                        <i data-lucide="heart" class="w-6 h-6 fill-current"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 relative max-w-xl mx-auto">
                <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø±ÙˆØ§ÙŠØ©..." 
                    class="w-full pr-10 pl-4 py-2 rounded-full text-gray-800 border-2 border-pink-300 focus:outline-none focus:border-pink-500 focus:ring-2 focus:ring-pink-200 dark:bg-darkCard dark:text-white dark:border-purple-500"
                    oninput="handleSearch(this.value)">
                <i data-lucide="search" class="absolute right-3 top-2.5 text-pink-400 w-5 h-5"></i>
            </div>
        </div>
    </header>

    <!-- Ø§Ù‚ØªØ¨Ø§Ø³ -->
    <div class="bg-white dark:bg-darkCard border-b border-pink-100 dark:border-purple-900 py-3">
        <div class="container mx-auto px-4 text-center">
            <p class="text-pink-600 dark:text-pink-300 font-deco text-lg italic animate-fade-in">
                "Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù‡ÙŠ Ø£Ù† ØªØ°Ù‡Ø¨ Ø¨Ø¹Ù‚Ù„Ùƒ ÙˆÙ…Ø´Ø§Ø¹Ø±Ùƒ Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ù…ÙƒØ§Ù†Ùƒ ÙˆØ²Ù…Ø§Ù†Ùƒ."
            </p>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="container mx-auto px-4 py-6 pb-20">
        
        <!-- Ø³Ù„Ø§ÙŠØ¯Ø± Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª -->
        <div id="featuredSection" class="mb-8 hidden animate-fade-in">
            <h2 class="text-2xl font-bold text-pink-700 dark:text-pink-400 mb-4 flex items-center gap-2">
                <i data-lucide="flame" class="w-6 h-6"></i> Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª
            </h2>
            <div id="featuredContainer" class="flex gap-4 overflow-x-auto pb-4 no-scrollbar snap-x"></div>
        </div>

        <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
        <div id="categoriesContainer" class="flex gap-3 overflow-x-auto pb-4 mb-2 no-scrollbar whitespace-nowrap"></div>

        <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Skeleton ÙˆÙƒØ±ÙˆØª Ø­Ù‚ÙŠÙ‚ÙŠØ©) -->
        <div id="novelsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
        </div>

        <!-- Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ© -->
        <div id="emptyState" class="hidden text-center py-20 text-gray-400 dark:text-gray-500">
            <p class="text-xl text-pink-400 dark:text-pink-600 font-bold font-deco">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ğŸ¦‹</p>
        </div>
    </div>

    <!-- ØªØ°ÙŠÙŠÙ„ -->
    <footer class="bg-pink-100 dark:bg-darkCard py-6 mt-10 text-center border-t border-pink-200 dark:border-purple-900">
        <p class="text-pink-800 dark:text-pink-200 mb-2 font-bold">Ù„Ù… ØªØ¬Ø¯ Ø±ÙˆØ§ÙŠØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŸ</p>
        <a href="https://docs.google.com/forms" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition shadow-md">
            <i data-lucide="edit-3" class="w-4 h-4"></i> Ø§Ø·Ù„Ø¨ Ø±ÙˆØ§ÙŠØ©
        </a>
        <p class="text-xs text-pink-400 mt-4 font-script text-xl">Made with love for Mary's Library</p>
    </footer>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div id="detailsModal" class="fixed inset-0 bg-pink-900/60 dark:bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity duration-300" onclick="closeDetailsModal()">
        <div class="bg-white dark:bg-darkCard rounded-2xl max-w-4xl w-full max-h-[95vh] overflow-y-auto no-scrollbar shadow-2xl relative border-2 border-pink-100 dark:border-purple-900 flex flex-col md:flex-row animate-slide-up" onclick="event.stopPropagation()">
            
            <button onclick="closeDetailsModal()" class="absolute top-4 left-4 bg-white/80 dark:bg-black/50 p-2 rounded-full hover:bg-white z-10 shadow-md text-gray-800 dark:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <!-- ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù -->
            <div class="w-full md:w-1/3 relative bg-gray-100 dark:bg-gray-800">
                <img id="modalCover" src="" class="w-full h-64 md:h-full object-cover">
                <div class="absolute bottom-0 w-full bg-gradient-to-t from-pink-900/90 to-transparent p-6 pt-20 md:hidden">
                    <h2 id="modalTitleMobile" class="text-2xl font-bold text-white drop-shadow-md font-deco"></h2>
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
            <div class="w-full md:w-2/3 p-6 md:p-8 flex flex-col">
                <div class="hidden md:block mb-4">
                    <span id="modalCategory" class="text-xs font-bold bg-pink-100 dark:bg-purple-900 text-pink-600 dark:text-pink-200 px-3 py-1 rounded-full mb-2 inline-block"></span>
                    <h2 id="modalTitle" class="text-3xl font-bold text-pink-800 dark:text-white font-deco"></h2>
                    <p id="modalAuthor" class="text-gray-500 dark:text-gray-400 mt-1"></p>
                </div>

                <div class="mb-4 flex-1 overflow-y-auto max-h-40 md:max-h-60 no-scrollbar">
                    <h3 class="text-lg font-bold text-pink-700 dark:text-pink-400 mb-2 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-5 h-5"></i> Ø§Ù„Ù‚ØµØ©
                    </h3>
                    <p id="modalDescription" class="text-gray-700 dark:text-gray-300 leading-relaxed whitespace-pre-line text-sm"></p>
                    
                    <!-- Ù‚Ø³Ù… Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© -->
                    <div id="similarBooksSection" class="mt-6 border-t border-pink-100 dark:border-purple-800 pt-4 hidden">
                        <h3 class="text-sm font-bold text-pink-500 mb-3">ğŸ¦‹ Ù‚Ø¯ ÙŠØ¹Ø¬Ø¨Ùƒ Ø£ÙŠØ¶Ø§Ù‹:</h3>
                        <div id="similarBooksContainer" class="grid grid-cols-3 gap-3"></div>
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-pink-100 dark:border-purple-800 space-y-3">
                    <div class="flex gap-3">
                        <button id="readNowBtn" onclick="toggleReadMode()" class="flex-1 flex items-center justify-center gap-2 bg-pink-600 text-white py-3 rounded-xl font-bold hover:bg-pink-700 transition shadow-sm">
                            <i data-lucide="book" class="w-5 h-5"></i> ØªØµÙØ­ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                        </button>
                        <button onclick="shareNovel()" class="px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-white rounded-xl hover:bg-gray-200 transition" title="Ù…Ø´Ø§Ø±ÙƒØ©">
                            <i data-lucide="share-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <button onclick="openFullScreen()" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition">
                        <i data-lucide="external-link" class="w-5 h-5"></i> Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
                    </button>
                </div>
                
                <div id="readerContainer" class="hidden mt-4 h-96 w-full bg-gray-100 dark:bg-gray-900 rounded-lg overflow-hidden border border-gray-300 relative animate-fade-in">
                    <iframe id="pdfFrame" src="" class="w-full h-full" frameborder="0"></iframe>
                    <button onclick="toggleReadMode()" class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded shadow hover:bg-red-600">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQroSmC0_KFPc19QWPzhaMRp8V16m2oVTBOloGJMofxw15Scq1YzomQj-So8e_E1IopP1VLyyh4v95Z/pub?output=csv"; 
        
        let novels = [];
        let searchTerm = '';
        let currentCategory = 'Ø§Ù„ÙƒÙ„';
        let favorites = JSON.parse(localStorage.getItem('maryFavs')) || [];
        let showingFavorites = false;
        let currentNovelLink = '';
        let currentPreviewLink = '';

        document.addEventListener('DOMContentLoaded', () => {
            checkDarkMode();
            loadDataFromSheet();
            lucide.createIcons();
            
            // Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù„Ø²Ø± Ø§Ù„ØµØ¹ÙˆØ¯
            window.onscroll = () => {
                const btn = document.getElementById('scrollTopBtn');
                if (window.scrollY > 300) {
                    btn.classList.remove('translate-y-20', 'opacity-0');
                    btn.classList.add('pointer-events-auto');
                } else {
                    btn.classList.add('translate-y-20', 'opacity-0');
                    btn.classList.remove('pointer-events-auto');
                }
            };
        });

        // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Toast)
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const bgClass = type === 'success' ? 'bg-green-600' : 'bg-pink-600';
            const iconName = type === 'success' ? 'check-circle' : 'heart';
            
            toast.className = `${bgClass} text-white px-6 py-3 rounded-xl shadow-lg transform transition-all duration-500 translate-y-10 opacity-0 flex items-center gap-3 min-w-[200px] pointer-events-auto`;
            toast.innerHTML = `
                <i data-lucide="${iconName}" class="w-5 h-5"></i>
                <span class="font-bold text-sm">${message}</span>
            `;

            container.appendChild(toast);
            lucide.createIcons();

            requestAnimationFrame(() => toast.classList.remove('translate-y-10', 'opacity-0'));

            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // 2. Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠ (Skeleton)
        function showSkeletonLoading() {
            const grid = document.getElementById('novelsGrid');
            grid.innerHTML = Array(6).fill(0).map(() => `
                <div class="bg-white dark:bg-darkCard rounded-xl shadow-md overflow-hidden border border-pink-100 dark:border-purple-900 h-96 animate-pulse">
                    <div class="h-64 bg-gray-300 dark:bg-gray-700 w-full"></div>
                    <div class="p-4 space-y-3">
                        <div class="h-6 bg-gray-300 dark:bg-gray-700 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-300 dark:bg-gray-700 rounded w-1/2"></div>
                        <div class="h-10 bg-gray-300 dark:bg-gray-700 rounded w-full mt-4"></div>
                    </div>
                </div>
            `).join('');
        }

        // 3. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function loadDataFromSheet() {
            showSkeletonLoading(); // Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    novels = results.data.filter(n => n.title && n.title.trim() !== "");
                    setupCategories();
                    renderFeatured();
                    renderNovels();
                },
                error: () => {
                    document.getElementById('novelsGrid').innerHTML = "<p class='text-red-500 text-center col-span-full'>ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ÙƒØªØ¨Ø©</p>";
                }
            });
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('maryDarkMode', document.documentElement.classList.contains('dark'));
        }
        function checkDarkMode() {
            if (localStorage.getItem('maryDarkMode') === 'true') document.documentElement.classList.add('dark');
        }

        function toggleFavorite(title, event) {
            event.stopPropagation();
            if (favorites.includes(title)) {
                favorites = favorites.filter(t => t !== title);
                showToast("ØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©", "info");
            } else {
                favorites.push(title);
                showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙØ¶Ù„Ø©", "success");
            }
            localStorage.setItem('maryFavs', JSON.stringify(favorites));
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø²Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù„Ø§ Ù†ÙÙ„ØªØ±
            if (showingFavorites) {
                renderNovels();
            } else {
                // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ù„Ø¨ ÙÙŠ Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„
                const btnIcon = event.currentTarget.querySelector('i'); // ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ù†Ø¯Ø±
                renderNovels(); // Ø§Ù„Ø£Ø¨Ø³Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ù†Ø¯Ø± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø§Ø³Ù‚
            }
        }

        function filterFavorites() {
            showingFavorites = !showingFavorites;
            const btn = document.getElementById('favFilterBtn');
            btn.classList.toggle('bg-pink-500', showingFavorites);
            btn.classList.toggle('text-white', showingFavorites);
            renderNovels();
        }

        function setupCategories() {
            const container = document.getElementById('categoriesContainer');
            const categories = ['Ø§Ù„ÙƒÙ„', ...new Set(novels.map(n => n.category).filter(c => c))];
            container.innerHTML = categories.map(cat => `
                <button onclick="filterByCategory('${cat}')" class="category-btn ${cat === 'Ø§Ù„ÙƒÙ„' ? 'active' : ''} px-6 py-2 rounded-full border border-pink-200 text-pink-700 dark:text-pink-300 font-bold bg-white dark:bg-darkCard hover:bg-pink-50 dark:hover:bg-gray-700 whitespace-nowrap shadow-sm transition-all duration-300">
                    ${cat}
                </button>
            `).join('');
        }

        function renderFeatured() {
            const container = document.getElementById('featuredContainer');
            const featuredSection = document.getElementById('featuredSection');
            const latest = novels.slice(0, 5);
            
            if (latest.length > 0) {
                featuredSection.classList.remove('hidden');
                container.innerHTML = latest.map(novel => `
                    <div class="snap-start shrink-0 w-36 md:w-44 cursor-pointer group" onclick="openDetails('${novel.title}')">
                        <div class="relative h-52 md:h-60 rounded-xl overflow-hidden mb-2 shadow-md bg-gray-200 dark:bg-gray-800">
                            <img src="${novel.cover}" loading="lazy" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='https://via.placeholder.com/400x600?text=No+Cover'">
                            <span class="absolute top-2 right-2 bg-red-500 text-white text-[10px] px-2 py-1 rounded-full font-bold shadow">Ø¬Ø¯ÙŠØ¯</span>
                        </div>
                        <h3 class="font-bold text-xs md:text-sm text-gray-800 dark:text-gray-200 truncate px-1">${novel.title}</h3>
                    </div>
                `).join('');
            }
        }

        function filterByCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText === cat);
            });
            renderNovels();
        }

        function renderNovels() {
            const grid = document.getElementById('novelsGrid');
            const empty = document.getElementById('emptyState');
            
            const filtered = novels.filter(n => {
                const search = n.title.toLowerCase().includes(searchTerm.toLowerCase());
                const cat = currentCategory === 'Ø§Ù„ÙƒÙ„' || n.category === currentCategory;
                const fav = !showingFavorites || favorites.includes(n.title);
                return search && cat && fav;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† (Staggered Animation)
                grid.innerHTML = filtered.map((novel, index) => {
                    const isFav = favorites.includes(novel.title);
                    const isNew = index < 5 && currentCategory === 'Ø§Ù„ÙƒÙ„' && !searchTerm;
                    
                    return `
                    <div class="bg-white dark:bg-darkCard rounded-xl shadow-md overflow-hidden hover:shadow-xl hover:shadow-pink-100 dark:hover:shadow-purple-900 transition duration-300 border border-pink-100 dark:border-purple-900 flex flex-col h-full relative group cursor-pointer animate-fade-in" onclick="openDetails('${novel.title}')">
                        
                        <div class="h-64 overflow-hidden relative bg-gray-200 dark:bg-gray-800">
                            <!-- Lazy Loading Image -->
                            <img src="${novel.cover}" loading="lazy" class="w-full h-full object-cover group-hover:scale-105 transition duration-500" onerror="this.src='https://via.placeholder.com/400x600?text=No+Cover'">
                            
                            <div class="absolute bottom-0 w-full bg-gradient-to-t from-black/70 to-transparent p-4 pt-10">
                                 <span class="text-white text-xs bg-pink-500/90 backdrop-blur-sm px-2 py-1 rounded-full mb-1 inline-block">${novel.category || 'Ø¹Ø§Ù…'}</span>
                            </div>
                            
                            <button onclick="toggleFavorite('${novel.title}', event)" class="absolute top-2 left-2 p-2 rounded-full bg-white/80 dark:bg-black/50 hover:scale-110 transition shadow-sm z-10 group-hover:bg-white dark:group-hover:bg-black/70">
                                <i data-lucide="heart" class="w-5 h-5 ${isFav ? 'fill-red-500 text-red-500' : 'text-gray-600 dark:text-gray-300'}"></i>
                            </button>
                            ${isNew ? '<span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold shadow animate-pulse">Ø¬Ø¯ÙŠØ¯</span>' : ''}
                        </div>
                        
                        <div class="p-4 flex-1 flex flex-col justify-between">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 dark:text-white mb-1 font-deco truncate">${novel.title}</h3>
                                <p class="text-gray-500 dark:text-gray-400 text-sm mb-3 flex items-center gap-1"><i data-lucide="pen-tool" class="w-3 h-3"></i> ${novel.author || 'Ù…Ø¬Ù‡ÙˆÙ„'}</p>
                            </div>
                            <button class="w-full bg-pink-50 dark:bg-gray-700 text-pink-700 dark:text-pink-300 py-2 rounded-lg font-bold hover:bg-pink-100 dark:hover:bg-gray-600 transition flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="eye" class="w-4 h-4"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                            </button>
                        </div>
                    </div>
                `}).join('');
                lucide.createIcons();
            }
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ù‚Ø±Ø§Ø¡Ø© ---
        function convertToPreviewUrl(url) {
            if (!url) return '';
            if (url.includes('drive.google.com') && url.includes('/view')) return url.replace('/view', '/preview');
            if (url.includes('drive.google.com') && url.includes('open?id=')) return url.replace('open?id=', 'file/d/') + '/preview';
            return url;
        }

        function openDetails(title) {
            const novel = novels.find(n => n.title === title);
            if(!novel) return;

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            document.getElementById('modalTitle').innerText = novel.title;
            document.getElementById('modalTitleMobile').innerText = novel.title;
            document.getElementById('modalAuthor').innerText = `Ø¨Ù‚Ù„Ù…: ${novel.author}`;
            document.getElementById('modalCategory').innerText = novel.category;
            document.getElementById('modalDescription').innerText = novel.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø±ÙˆØ§ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.";
            document.getElementById('modalCover').src = novel.cover;
            
            currentNovelLink = novel.pdfLink;
            currentPreviewLink = convertToPreviewUrl(novel.pdfLink);

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            document.getElementById('readerContainer').classList.add('hidden');
            document.getElementById('pdfFrame').src = "";
            
            // --- Ù…ÙŠØ²Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Similar Books) ---
            const similar = novels.filter(n => n.category === novel.category && n.title !== title).slice(0, 3);
            const similarContainer = document.getElementById('similarBooksContainer');
            const similarSection = document.getElementById('similarBooksSection');

            if (similar.length > 0) {
                similarSection.classList.remove('hidden');
                similarContainer.innerHTML = similar.map(n => `
                    <div class="cursor-pointer group bg-gray-50 dark:bg-gray-800 rounded-lg p-2 hover:bg-pink-50 dark:hover:bg-gray-700 transition" onclick="openDetails('${n.title}')">
                        <div class="h-24 rounded-md overflow-hidden mb-1 relative">
                             <img src="${n.cover}" class="w-full h-full object-cover group-hover:scale-110 transition">
                        </div>
                        <p class="text-[10px] text-center font-bold truncate dark:text-gray-300">${n.title}</p>
                    </div>
                `).join('');
            } else {
                similarSection.classList.add('hidden');
            }

            document.getElementById('detailsModal').classList.replace('hidden', 'flex');
        }

        function toggleReadMode() {
            const container = document.getElementById('readerContainer');
            const frame = document.getElementById('pdfFrame');
            
            if (container.classList.contains('hidden')) {
                if(currentPreviewLink) {
                    frame.src = currentPreviewLink;
                    container.classList.remove('hidden');
                } else {
                    showToast("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªÙˆÙØ±", "info");
                }
            } else {
                container.classList.add('hidden');
                frame.src = "";
            }
        }

        function openFullScreen() {
            if(currentNovelLink) {
                window.open(currentNovelLink, '_blank');
            } else {
                showToast("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªÙˆÙØ±", "info");
            }
        }

        function shareNovel() {
            const title = document.getElementById('modalTitle').innerText;
            if (navigator.share) {
                navigator.share({
                    title: `Ù…ÙƒØªØ¨Ø© Ù…Ø§Ø±ÙŠ: ${title}`,
                    text: `Ø§Ù‚Ø±Ø£ Ø±ÙˆØ§ÙŠØ© "${title}" Ø§Ù„Ù…Ù…ØªØ¹Ø© ÙÙŠ Ù…ÙƒØªØ¨Ø© Ù…Ø§Ø±ÙŠ!`,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹!", "success");
            }
        }

        function closeDetailsModal() { document.getElementById('detailsModal').classList.replace('flex', 'hidden'); }
        function handleSearch(val) { searchTerm = val; renderNovels(); }
    </script>
</body>
</html>
